#!/usr/bin/env python3
import sys
import subprocess
import requests
import json
from rich.console import Console
from rich.panel import Panel
from rich.markdown import Markdown

console = Console()
MODEL = "qwen2.5-coder:1.5b"

def get_cheat_sheet(pkg):
    prompt = f"Provide a concise cheat sheet for the linux command '{pkg}'. List top 5 most useful examples. Output in Markdown. Keep it under 200 words."
    try:
        r = requests.post("http://localhost:11434/api/generate", json={
            "model": MODEL,
            "prompt": prompt,
            "stream": False
        }, timeout=180)
        if r.status_code == 200:
            return r.json()['response']
    except:
        return "Could not generate cheat sheet (Ollama unreachable)."
    return "Error generating cheat sheet."

def main():
    if len(sys.argv) < 2:
        console.print("[red]Usage: privypm <package_name>[/red]")
        return

    pkg = sys.argv[1]
    console.print(f"[bold green]PrivyPM:[/bold green] Installing [cyan]{pkg}[/cyan]...")
    
    # Run apt-get
    res = subprocess.run(["sudo", "apt-get", "install", "-y", pkg])
    
    if res.returncode == 0:
        console.print(f"[bold green]Success![/bold green] Generating cheat sheet for [cyan]{pkg}[/cyan]...")
        cheat = get_cheat_sheet(pkg)
        console.print(Panel(Markdown(cheat), title=f"Cheat Sheet: {pkg}", border_style="blue"))
    else:
        console.print(f"[bold red]Failed to install {pkg}.[/bold red]")

if __name__ == "__main__":
    main()